# RAG 동작 원리 설명 - 파일 검색 스토어 기반

## 📚 전체 흐름 개요

이 코드는 **Google의 파일 검색 스토어(FileSearchStore)**를 활용한 RAG(Retrieval-Augmented Generation) 시스템입니다.

```
[Google Docs 문서] → [PDF 다운로드] → [FileSearchStore 업로드] → [청크 분할 & 인덱싱] 
→ [질문 입력] → [관련 문서 검색] → [컨텍스트 + 질문] → [Gemini 모델] → [답변 생성]
```

---

## 🔍 단계별 상세 설명

### 1단계: 문서 준비 및 다운로드 (33-42줄)

```python
document_url = f"https://docs.google.com/document/d/{DOCUMENT_ID}/export?format=pdf"
response = requests.get(document_url)
```

**동작 원리:**
- Google Docs 문서를 PDF 형식으로 내보내기
- 로컬에 PDF 파일로 저장
- **목적**: Google AI가 처리할 수 있는 형식으로 변환

---

### 2단계: 파일 검색 스토어에 업로드 (45-47줄)

```python
uploaded_file = genai.upload_file(path=PDF_FILE_NAME, display_name=DOCUMENT_NAME)
```

**동작 원리 (파일 검색 스토어 문서 기준):**

이 단계에서 내부적으로 다음과 같은 과정이 일어납니다:

1. **FileSearchStore 생성/접근**
   - `FileSearchStore`는 Document들의 모음입니다
   - 각 업로드된 파일은 `Document`로 변환됩니다

2. **자동 전처리 및 청크 분할** 
   - [파일 검색 스토어 문서](https://ai.google.dev/api/file-search/file-search-stores?hl=ko)에 따르면:
   - `uploadToFileSearchStore` 메서드가 데이터를 **전처리하고 청크로 나눕니다**
   - `chunkingConfig`를 통해 청크 분할 방식을 제어할 수 있습니다 (기본값 사용 시 자동 처리)
   
3. **인덱싱**
   - 각 청크는 검색 가능한 형태로 인덱싱됩니다
   - 의미 기반 검색을 위한 벡터 임베딩이 생성됩니다

**핵심**: 단순히 파일을 저장하는 것이 아니라, **검색 가능한 지식 베이스**로 변환됩니다!

---

### 3단계: RAG 질의-응답 (49-58줄)

```python
model = genai.GenerativeModel(model_name='gemini-2.0-flash-exp')
response = model.generate_content([query, uploaded_file])
```

**동작 원리 (RAG 프로세스):**

#### 3-1. 질문 입력
```python
query = "시그니처 메뉴의 가격을 알려주세요."
```

#### 3-2. 검색 단계 (Retrieval)
- 사용자의 질문이 입력되면
- **FileSearchStore에서 관련 문서 청크를 검색**합니다
- 의미적으로 유사한 내용을 찾아냅니다
  - 예: "시그니처 메뉴", "가격"과 관련된 청크들을 검색

#### 3-3. 증강 단계 (Augmentation)
- 검색된 관련 청크들이 **컨텍스트**로 모델에 제공됩니다
- 모델은 이 컨텍스트를 바탕으로 답변을 생성합니다

#### 3-4. 생성 단계 (Generation)
- Gemini 모델이 다음을 결합합니다:
  - ✅ 검색된 문서 내용 (컨텍스트)
  - ✅ 사용자의 질문
  - ✅ 모델의 일반 지식
- 최종 답변을 생성합니다

---

## 🎯 파일 검색 스토어의 핵심 개념

### FileSearchStore란?

[공식 문서](https://ai.google.dev/api/file-search/file-search-stores?hl=ko)에 따르면:

> **FileSearchStore**는 `Document`의 모음입니다. Google 인프라를 사용하여 검색 증강 생성(RAG) 시스템을 빌드하기 위한 호스팅 질의 응답 서비스를 제공합니다.

### 주요 특징:

1. **자동 청크 분할**
   - 긴 문서를 의미 있는 단위로 자동 분할
   - 검색 효율성 향상

2. **의미 기반 검색**
   - 단순 키워드 매칭이 아닌 의미적 유사도 기반 검색
   - "가격"을 물어보면 "요금", "비용" 등도 찾아냄

3. **호스팅 서비스**
   - Google 인프라에서 관리
   - 별도의 벡터 DB 구축 불필요

---

## 💡 현재 코드의 RAG 동작 흐름

```
┌─────────────────────────────────────────────────────────┐
│ 1. 문서 준비                                             │
│    Google Docs → PDF 다운로드                           │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 2. FileSearchStore 업로드                                │
│    - 파일 업로드                                         │
│    - 자동 전처리 & 청크 분할                            │
│    - 인덱싱 (검색 가능한 형태로 변환)                   │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 질문 입력                                             │
│    "시그니처 메뉴의 가격을 알려주세요."                  │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 4. 검색 (Retrieval)                                      │
│    FileSearchStore에서 관련 청크 검색                    │
│    → "시그니처 메뉴", "가격" 관련 내용 찾기             │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 증강 (Augmentation)                                   │
│    검색된 청크들을 컨텍스트로 준비                       │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 6. 생성 (Generation)                                     │
│    Gemini 모델이 컨텍스트 + 질문 → 답변 생성            │
│    → "랍스터 비스크 수프: 18,500원..."                   │
└─────────────────────────────────────────────────────────┘
```

---

## 🔑 핵심 포인트

1. **자동화된 인프라**
   - 청크 분할, 인덱싱, 검색이 모두 자동으로 처리됨
   - 개발자는 파일만 업로드하면 됨

2. **의미 기반 검색**
   - 단순 텍스트 매칭이 아닌 의미적 유사도 기반
   - 더 정확한 관련 정보 검색

3. **실시간 RAG**
   - 질문이 들어오면 즉시 검색 → 증강 → 생성
   - 별도의 벡터 DB 구축이나 관리 불필요

4. **확장 가능성**
   - 여러 문서를 하나의 FileSearchStore에 업로드 가능
   - 대규모 지식 베이스 구축 가능

---

## 📖 참고 자료

- [파일 검색 스토어 공식 문서](https://ai.google.dev/api/file-search/file-search-stores?hl=ko)
- FileSearchStore는 Document의 모음으로, RAG 시스템을 위한 호스팅 질의 응답 서비스를 제공합니다
- `uploadToFileSearchStore` 메서드를 통해 자동으로 전처리 및 청크 분할이 수행됩니다

